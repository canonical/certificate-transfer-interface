name: CI

on:
  push:
  pull_request:

jobs:
  lint-report:
    name: Lint report
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4
      - name: Install tox
        run: pip install tox
      - name: Run tests using tox
        run: tox -e lint

  static-analysis:
    name: Static analysis
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4
      - name: Install tox
        run: pip install tox
      - name: Run tests using tox
        run: tox -e static

  unit-tests-with-coverage:
    name: Unit tests
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4
      - name: Install tox
        run: pip install tox
      - name: Run tests using tox
        run: tox -e unit

  can-publish:
    name: Can Publish
    runs-on: ubuntu-22.04
    steps:
      - name: Install charmcraft
        run: sudo snap install charmcraft --classic

      - name: Can manage package
        env:
          CHARMCRAFT_AUTH: "${{ secrets.CHARMCRAFT_AUTH}}"
        run: |
          charmcraft whoami --format json | jq '.permissions[]' | grep "package-manage"
          charmcraft whoami --format json | jq '.charms[].name' | grep "certificate-transfer-interface"

  charm-builds:
    name: Charm builds
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4

      - name: Install charmcraft
        run: sudo snap install charmcraft --classic

      - name: Setup LXD
        uses: canonical/setup-lxd@main
        with:
          channel: 5.13/stable

      - name: Build charm
        run: charmcraft pack --verbose

